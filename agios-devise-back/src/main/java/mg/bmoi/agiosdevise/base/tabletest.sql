ALTER SESSION SET CONTAINER = ORCLPDB;


CREATE USER MGSTGADR IDENTIFIED BY Andrew2963;
GRANT DBA TO C##MGSTGADR;

CREATE TABLE C##MGSTGADR.ROLE (
    id_role NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nom_role VARCHAR2(50) UNIQUE NOT NULL
);

commit;
SELECT* FROM C##MGSTGADR.USER_APP;
CREATE TABLE C##MGSTGADR.USER_APP (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(50) UNIQUE NOT NULL
        CHECK (REGEXP_LIKE(username, '^[A-Za-z0-9_]+$')),
    email_bmoi VARCHAR2(100) NOT NULL
        CHECK (email_bmoi LIKE '%@bmoi.mg'),
    mdp VARCHAR2(255) NOT NULL,
    role NUMBER NOT NULL,
    created_at DATE DEFAULT SYSDATE NOT NULL,
    is_active NUMBER(1) DEFAULT 1 NOT NULL,
    CONSTRAINT fk_user_app_role FOREIGN KEY (role) REFERENCES C##MGSTGADR.ROLE (id_role)
);

CREATE INDEX idx_user_app_role ON C##MGSTGADR.USER_APP(role);
SELECT * FROM C##MGSTGADR.ROLE;
SELECT * FROM C##MGSTGADR.USER_APP;


-- 1. Creation de la table
CREATE TABLE C##MGSTGADR.TICDEVISE (
                          CDALPHA     VARCHAR2(3)   NOT NULL,
                          CDISO  VARCHAR2(10)    NOT NULL,
                          LIBELE  VARCHAR2(200) NOT NULL,
                          VALEUR DECIMAL(19, 4) DEFAULT 0,
                          CONSTRAINT PK_TBDEVISE PRIMARY KEY (CDISO)
);

SELECT * FROM C##MGSTGADR.DASHBOARD_ARRETE;

SELECT * FROM C##MGSTGADR.TICDEVISE order by CDALPHA;

COMMIT;


------------------------------------

INSERT INTO C##MGSTGADR.ROLE (nom_role) VALUES ('ADMIN');
INSERT INTO C##MGSTGADR.ROLE (nom_role) VALUES ('PUPITREUR');
INSERT INTO C##MGSTGADR.ROLE (nom_role) VALUES ('CONSULTANT');
INSERT INTO C##MGSTGADR.ROLE (nom_role) VALUES ('TESTEUR');

    INSERT INTO C##MGSTGADR.USER_APP (username, email_bmoi, mdp, role, created_at, is_active) VALUES (
       'admin',
       'admin@bmoi.mg',
       'rakoto',
       1,
       SYSDATE,
       1
    );
    
    INSERT INTO C##MGSTGADR.USER_APP 
(username, email_bmoi, mdp, role, created_at, is_active)
VALUES (
   'andrew',
   'andrew@bmoi.mg',
   'andrew',
   1,
   SYSDATE,
   1
);
SELECT * from C##MGSTGADR.USER_APP;
    INSERT INTO C##MGSTGADR.USER_APP (username, email_bmoi, mdp, role, created_at, is_active) VALUES (
       'pup',
       'pup@bmoi.mg',
       'pup',
       2,
       SYSDATE,
       1
);

INSERT INTO C##MGSTGADR.USER_APP (username, email_bmoi, mdp, role, created_at, is_active) VALUES (
   'test1',
   'test1@bmoi.mg',
   'test',
   3,
   SYSDATE,
   1
);
         
commit;

select * from C##MGSTGADR.user_app;
----------------------------------

CREATE TABLE C##MGSTGADR.BKSLD_D (
    AGE   VARCHAR2(10),
    DEV   VARCHAR2(3),
    NCP   VARCHAR2(20),
    SDE   NUMBER(18,2)
);

select * from C##MGSTGADR.BKDAR_D;

CREATE TABLE C##MGSTGADR.BKDAR_D (
    AGE      VARCHAR2(10),
    DEV      VARCHAR2(3),
    NCP      VARCHAR2(20),
    NBC      NUMBER,
    TXC      NUMBER(10,4),
    NBR      NUMBER,
    TAUX     NUMBER(10,4),
    SOLDE    NUMBER(18,2),
    NOMREST  VARCHAR2(100),
    ADR1     VARCHAR2(100),
    ADR2     VARCHAR2(100),
    CPOS     VARCHAR2(10),
    CLC      VARCHAR2(10),
    DATR     DATE,
    TCLI     VARCHAR2(10),
    VIL      VARCHAR2(50),
    CLI      VARCHAR2(20)
);

CREATE TABLE C##MGSTGADR.BKHIS_D (
    AGE VARCHAR2(10),
    DEV       VARCHAR2(3),
    NCP       VARCHAR2(20),
    DCO       DATE,
    DVA       DATE,
    MON       NUMBER(18,2),
    SEN       CHAR
);
commit;



CREATE TABLE C##MGSTGADR.HISTORIQUE_ARRETE (
    AGE                 VARCHAR2(10),
    DEV                 VARCHAR2(10),
    NCP                 VARCHAR2(20),
    NOMREST             VARCHAR2(500),
    SOLDE_FINAL_CALCULE NUMBER(18,2),
    DATE_DEBUT_ARRETE   DATE,
    DATE_FIN_ARRETE     DATE,
    SUM_MVT_CREDITEUR   NUMBER(18,2),
    TAUX_CREDITEUR      NUMBER(12,7),
    INTERET_CREDITEUR   NUMBER(12,7),
    SUM_MVT_DEBITEUR    NUMBER(18,2),
    TAUX_DEBITEUR       NUMBER(10,7),
    INTERET_DEBITEUR    NUMBER(10,7),
    NET_AGIOS           NUMBER(18,2),
    ISKO                NUMBER(1) DEFAULT 0,
    TCLI                VARCHAR2(20),
    CONSTRAINT FK_DEV FOREIGN KEY (DEV) REFERENCES C##MGSTGADR.TICDEVISE(CDISO)
);

DELETE FROM C##MGSTGADR.HISTORIQUE_ARRETE;

ALTER TABLE C##MGSTGADR.HISTORIQUE_ARRETE
    MODIFY (
        SOLDE_FINAL_CALCULE NUMBER(20,4),
        SUM_MVT_CREDITEUR   NUMBER(30,8),
        TAUX_CREDITEUR      NUMBER(20,7),
        INTERET_CREDITEUR   NUMBER(20,8),
        SUM_MVT_DEBITEUR    NUMBER(30,8),
        TAUX_DEBITEUR       NUMBER(20,7),
        INTERET_DEBITEUR    NUMBER(20,8),
        NET_AGIOS           NUMBER(20,8)
        );

commit;
SELECT* FROM C##MGSTGADR.TICDEVISE;

CREATE TABLE C##MGSTGADR.DASHBOARD_ARRETE (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TOT_COMPTES_TRAITES NUMBER,
    NB_COMPTE_KO NUMBER,
    DATE_DEBUT_ARRETE DATE,
    DATE_FIN_ARRETE DATE,
    DATE_HEURE_DEBUT_CALCUL TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DATE_HEURE_FIN_CALCUL TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM C##MGSTGADR.BKDAR_D;
SELECT * FROM C##MGSTGADR.BKSLD_D;
SELECT * FROM C##MGSTGADR.BKHIS_D;
SELECT * FROM C##MGSTGADR.TEST_BKHIS;
SELECT * FROM C##MGSTGADR.DASHBOARD_ARRETE;
DELETE FROM C##MGSTGADR.HISTORIQUE_ARRETE;
SELECT * FROM C##MGSTGADR.HISTORIQUE_ARRETE;
commit;
CREATE TABLE C##MGSTGADR.DEROGATION (
  AGE VARCHAR2(10),
  DEV VARCHAR2(5),
  NCP VARCHAR2(20),
  CHA VARCHAR2(10),
  CLC VARCHAR2(5),
  CLI VARCHAR2(20),
  INTI VARCHAR2(50),
  TYP VARCHAR2(5),
  GES VARCHAR2(5),
  EN_DEROGATION NUMBER(1) DEFAULT 0,
  CONSTRAINT PK_DEROGATION PRIMARY KEY (NCP)
);
SELECT* FROM C##MGSTGADR.DEROGATION;
delete from C##MGSTGADR.ROLE where id_role = 4;

-- Rï¿½partition agios --
CREATE OR REPLACE VIEW C##MGSTGADR.V_HISTO_ARRETE_DEVISE AS
SELECT 
    h.DEV,
    h.DATE_DEBUT_ARRETE,
    h.DATE_FIN_ARRETE,
    SUM(h.NET_AGIOS) AS TOTAL_NET_AGIOS,
    t.CDALPHA,
    t.LIBELE
FROM 
    C##MGSTGADR.HISTORIQUE_ARRETE h
JOIN 
    C##MGSTGADR.TICDEVISE t
    ON h.DEV = t.CDISO
GROUP BY
    h.DEV,
    h.DATE_DEBUT_ARRETE,
    h.DATE_FIN_ARRETE,
    t.CDALPHA,
    t.LIBELE;

    
SELECT * FROM C##MGSTGADR.V_HISTO_ARRETE_DEVISE



-- Agios part type de client --
CREATE OR REPLACE VIEW C##MGSTGADR.V_SUM_AGIOS_PAR_TCLI AS
SELECT 
    h.TCLI,
    h.DEV,
    h.DATE_DEBUT_ARRETE,
    h.DATE_FIN_ARRETE,
    t.CDALPHA,
    t.LIBELE,
    ABS(SUM(h.NET_AGIOS)) AS TOTAL_NET_AGIOS
FROM 
    C##MGSTGADR.HISTORIQUE_ARRETE h
JOIN 
    C##MGSTGADR.TICDEVISE t
    ON h.DEV = t.CDISO    
GROUP BY
    h.TCLI,
    h.DEV,
    h.DATE_DEBUT_ARRETE,
    h.DATE_FIN_ARRETE,
    t.CDALPHA,
    t.LIBELE;

SELECT * FROM C##MGSTGADR.V_SUM_AGIOS_PAR_TCLI;
select* from bank.bkage;

SELECT DEV, DATE_DEBUT_ARRETE, DATE_FIN_ARRETE, ABS(TOTAL_NET_AGIOS) AS TOTAL_NET_AGIOS, CDALPHA, LIBELE
FROM C##MGSTGADR.V_HISTO_ARRETE_DEVISE
WHERE DATE_DEBUT_ARRETE = :dateDebut
AND DATE_FIN_ARRETE = :dateFin
ORDER BY ABS(TOTAL_NET_AGIOS) DESC;

CREATE TABLE C##MGSTGADR.BKTAU (
    age VARCHAR2(5),
    dco DATE,
    dev VARCHAR2(3),
    tind NUMBER(15,7)
);
commit;
SELECT COUNT(*) FROM C##MGSTGADR.BKTAU WHERE dco = TO_DATE('28/03/25', 'DD/MM/YY');

CREATE TABLE C##MGSTGADR.BKAGE (
    age VARCHAR2(5),
    lib VARCHAR2(30)
);

INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00001', 'ANTANANARIVO');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00002', 'TSARALALANA');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00003', 'ANALAMAHITSY');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00004', 'ANKORONDRANO');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00005', 'TALATAMATY');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00006', 'ANTSIRABE');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00007', 'PRESTIGE');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00008', 'PRESTIGE EDEN');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00009', 'TANJOMBATO');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00010', 'TOAMASINA');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00011', 'CAFF TOAMASINA');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00012', 'CAFF EDEN');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00014', 'BMOI GALAXY');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00015', 'BMOI AUGAGNEUR');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00016', 'BMOI AGENCE TULEAR');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00017', 'BMOI AGENCE BY-PASS');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00020', 'ANTSIRANANA');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00025', 'SAMBAVA');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00026', 'NOSY BE');
INSERT INTO C##MGSTGADR.BKAGE (age, lib) VALUES ('00030', 'MAHAJANGA');
                
SELECT * FROM C##MGSTGADR.BKAGE;         
commit;